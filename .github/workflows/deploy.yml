name: Deploy to FTP

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Enable maintenance mode
        run: |
          sed -i "s/maintenance: false/maintenance: true/" js/option/mizuna_option.js
          cat js/option/mizuna_option.js  # 確認用（ログ出力）

      - name: Clear FTP Directory
        uses: SamKirkland/FTP-Deploy-Action@4.3.4
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          server-dir: "${{ secrets.FTP_TARGET_DIR }}"
          dangerous-clean-slate: true  # すべて削除

      - name: Deploy files via FTP
        uses: SamKirkland/FTP-Deploy-Action@4.3.4
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: "./"
          server-dir: "${{ secrets.FTP_TARGET_DIR }}"

      - name: Wait for 15 minutes
        run: sleep 900  # 900秒 = 15分

      - name: Disable maintenance mode
        run: |
          sed -i "s/maintenance: true/maintenance: false/" js/option/mizuna_option.js
          cat js/option/mizuna_option.js  # 確認用（ログ出力）

      - name: Re-upload only mizuna_option.js
        uses: SamKirkland/FTP-Deploy-Action@4.3.4
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: "js/option/"
          server-dir: "${{ secrets.FTP_TARGET_DIR }}js/option/"
          exclude: "*"  # デフォルトで全除外
          include: "mizuna_option.js"  # このファイルのみアップロード
