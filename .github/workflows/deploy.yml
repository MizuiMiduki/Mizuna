name: Deploy to FTP

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      manual_ftp_build_time:
        description: 'Custom wait time before re-uploading mizuna_option.js (seconds)'
        required: false
        default: ''

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Enable maintenance mode
        run: |
          sed -i "s/maintenance: false/maintenance: true/" js/option/mizuna_option.js
          cat js/option/mizuna_option.js

      - name: Upload only mizuna_option.js with maintenance mode enabled
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: "js/option/"
          server-dir: "${{ secrets.FTP_TARGET_DIR }}js/option/"
          exclude: "*"
          include: "mizuna_option.js"

      - name: Upload all other files (excluding mizuna_option.js)
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: "./"
          server-dir: "${{ secrets.FTP_TARGET_DIR }}"
          exclude: "js/option/mizuna_option.js"

      - name: Determine wait time
        id: wait_time
        run: |
          if [ -n "${{ github.event.inputs.manual_ftp_build_time }}" ]; then
            echo "WAIT_TIME=${{ github.event.inputs.manual_ftp_build_time }}" >> $GITHUB_ENV
          else
            echo "WAIT_TIME=${{ secrets.FTP_BUILD_TIME }}" >> $GITHUB_ENV
          fi

      - name: Wait for configured time
        run: sleep $WAIT_TIME

      - name: Checkout the latest mizuna_option.js
        run: git checkout HEAD js/option/mizuna_option.js

      - name: Re-upload latest mizuna_option.js
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: "js/option/"
          server-dir: "${{ secrets.FTP_TARGET_DIR }}js/option/"
          exclude: "*"
          include: "mizuna_option.js"